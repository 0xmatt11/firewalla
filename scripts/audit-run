#!/bin/bash

: ${FIREWALLA_HOME:=/home/pi/firewalla}
source ${FIREWALLA_HOME}/platform/platform.sh

logger 'FIREWALLA.ACLAUDIT Starting'

sudo mkdir -p /alog/
sudo rm -r -f /alog/*

# ensure log file is readable
sudo mkfifo /alog/acl-audit.log
sudo chgrp adm /alog/acl-audit.log
sudo chown syslog /alog/acl-audit.log
sudo chmod 644 /alog/acl-audit.log

# sudo ln -s /alog/acl-audit.log /var/log/acl-audit.log
sudo mkdir -p /log/alog
sudo ln -sf /alog/acl-audit.log /log/alog/acl-audit.log


sudo cp ${FIREWALLA_HOME}/etc/rsyslog.d/30-acl-audit.conf /etc/rsyslog.d/
sudo systemctl restart rsyslog

sudo iptables -C FW_DROP -j LOG --log-prefix "[FW_ACL_AUDIT]" &>/dev/null || sudo iptables -I FW_DROP -j LOG --log-prefix "[FW_ACL_AUDIT]"
sudo ip6tables -C FW_DROP -j LOG --log-prefix "[FW_ACL_AUDIT]" &>/dev/null || sudo ip6tables -I FW_DROP -j LOG --log-prefix "[FW_ACL_AUDIT]"

logger 'FIREWALLA.ACLAUDIT Finished Starting'
